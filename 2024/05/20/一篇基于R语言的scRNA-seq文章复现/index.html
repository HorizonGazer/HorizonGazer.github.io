

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/xd.jpg">
  <link rel="icon" href="/img/xd.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="HorizonGazer">
  <meta name="keywords" content="">
  
    <meta name="description" content="1  文章概述 文章标题：Comprehensive single-cell transcriptomic and proteomic analysis reveals NK cell exhaustion and unique tumor cell evolutionary trajectory in non-keratinizing nasopharyngeal carcinoma 2023年">
<meta property="og:type" content="article">
<meta property="og:title" content="一篇基于R语言的scRNA-seq文章复现">
<meta property="og:url" content="http://horizongazer.github.io/2024/05/20/%E4%B8%80%E7%AF%87%E5%9F%BA%E4%BA%8ER%E8%AF%AD%E8%A8%80%E7%9A%84scRNA-seq%E6%96%87%E7%AB%A0%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="HorizonGazer">
<meta property="og:description" content="1  文章概述 文章标题：Comprehensive single-cell transcriptomic and proteomic analysis reveals NK cell exhaustion and unique tumor cell evolutionary trajectory in non-keratinizing nasopharyngeal carcinoma 2023年">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://horizongazer.github.io/img/Fig3.I.png">
<meta property="article:published_time" content="2024-05-19T16:00:00.000Z">
<meta property="article:modified_time" content="2024-07-09T14:45:41.921Z">
<meta property="article:author" content="HorizonGazer">
<meta property="article:tag" content="R">
<meta property="article:tag" content="scRNA-seq">
<meta property="article:tag" content="paper-reproducing">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://horizongazer.github.io/img/Fig3.I.png">
  
  
  
  <title>一篇基于R语言的scRNA-seq文章复现 - HorizonGazer</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"horizongazer.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"kSreM0uY5jXWPRahJhw2LDbE-gzGzoHsz","app_key":"Ux8qZ1XPuB6R9or0uKIElE9b","server_url":"https://ksrem0uy.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="HorizonGazer" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>HorizonGazer</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/background.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="一篇基于R语言的scRNA-seq文章复现"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-05-20 00:00" pubdate>
          2024年5月20日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          50 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">一篇基于R语言的scRNA-seq文章复现</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1-文章概述">1  文章概述</h2>
<p>文章标题：<a target="_blank" rel="noopener" href="https://doi.org/10.1186%2Fs12967-023-04112-8"><em><strong>Comprehensive single-cell transcriptomic and proteomic analysis reveals NK cell exhaustion and unique tumor cell evolutionary trajectory in non-keratinizing nasopharyngeal carcinoma</strong></em></a></p>
<p>2023年发表于Journal of Translational Medicine，IF=7.4</p>
<h2 id="2-文章实验设计">2  文章实验设计</h2>
<p>目的：<strong>研究NK细胞和肿瘤细胞在非角化性鼻咽癌（NK-NPC）中的作用，NK-NPC与EBV感染密切相关</strong></p>
<p>方法：<strong>收集3例NK-NPC样本和3例正常鼻咽黏膜样本进行蛋白质组分析，联合GSE162025（NK-NPC单细胞转录组数据）和GSE150825（NLH单细胞转录组数据）进行分析</strong></p>
<p>分析步骤：</p>
<ol>
<li>
<p>对蛋白组数据进行分析，发现NK细胞介导的细胞毒性相关蛋白显著下调，NK细胞功能可能受到抑制。</p>
</li>
<li>
<p>免疫组化发现NK-NPC样本中，与NK细胞相关的B2M，CD56+，Granzyme B均下调</p>
</li>
<li>
<p>对NK-NPC单细胞转录组样本进行分析，T细胞，B细胞，NK细胞在所有类型的细胞中排名前三</p>
</li>
<li>
<p>对NK细胞取子集进行细分，得到1个mast cell和3个NK细胞cluster，从NK细胞毒性激活/抑制，细胞通讯，NK细胞功能相关的标志物，NK细胞介导的毒性通路等角度进行分析，并用NLH单细胞转录数据集进行验证</p>
</li>
<li>
<p>对上皮细胞取子集进行细分，用copykat鉴定良性和恶性上皮细胞，对恶性上皮细胞再进行细分，得到tumor1和tumor2两类，考察多个关键基因，发现EBV感染可能与tumor1相关</p>
</li>
<li>
<p>对tumor1再取子集，得到4个cluster，用拟时序分析4个cluster之间的演变过程，分析了关键基因和通路在不同cluster之间的变化，推测EBV感染的机制</p>
</li>
</ol>
<h2 id="3-复现前准备">3  复现前准备</h2>
<h3 id="3-1-数据">3.1  数据</h3>
<table>
<thead>
<tr>
<th>数据</th>
<th>数据说明</th>
<th>来源</th>
</tr>
</thead>
<tbody>
<tr>
<td>12967_2023_4112_MOESM1_ESM.xlsx</td>
<td>NK-NPC蛋白质组学结果</td>
<td><a target="_blank" rel="noopener" href="https://static-content.springer.com/esm/art%3A10.1186%2Fs12967-023-04112-8/MediaObjects/12967_2023_4112_MOESM1_ESM.xlsx">文献附件</a></td>
</tr>
<tr>
<td>GSE162025_RAW</td>
<td>使用单细胞转录组和 T 细胞受体测序对分析来自 10 对 NPC 肿瘤血对的 176,447 个细胞</td>
<td><a target="_blank" rel="noopener" href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE162025">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE162025</a></td>
</tr>
<tr>
<td>GSE150825_RAW(barcodes.tsv.gz, features.tsv.gz, matrix.mtx.gz)</td>
<td>鼻咽癌微环境的单细胞转录组分析和免疫谱分析</td>
<td><a target="_blank" rel="noopener" href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?&amp;acc=GSE150825">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?&amp;acc=GSE150825</a></td>
</tr>
</tbody>
</table>
<h3 id="3-2-平台和软件">3.2  平台和软件</h3>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">platform       x86_64-w64-mingw32   <br></code></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>软件</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>R</td>
<td>4.3.1</td>
</tr>
<tr>
<td>RStudio</td>
<td>2024.04.0</td>
</tr>
</tbody>
</table>
<h2 id="4-复现流程">4  复现流程</h2>
<h3 id="4-1-导入包">4.1  导入包</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-keyword">if</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>library<span class="hljs-punctuation">(</span>Seurat<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>data.table<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>stringr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>readxl<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>tibble<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>limma<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>dplyr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggrepel<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>pheatmap<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>clusterProfiler<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>org.Hs.eg.db<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>tidyverse<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>scRNAtoolVis<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>enrichplot<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>GSEABase<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>msigdbr<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>CellChat<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>copykat<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>patchwork<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>SCORPIUS<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<h3 id="4-2-NK-NPC蛋白质组学分析">4.2  NK-NPC蛋白质组学分析</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs R">setwd<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;C:\\Users\\汐\\Desktop\\R语言复现\\NK细胞耗竭和肿瘤细胞进化轨迹&quot;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># proteomics</span><br>data_pro <span class="hljs-operator">&lt;-</span> read_xlsx<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;rawdata/12967_2023_4112_MOESM1_ESM.xlsx&#x27;</span><span class="hljs-punctuation">)</span><br>data_pro <span class="hljs-operator">&lt;-</span> data_pro<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">23</span><span class="hljs-punctuation">,</span><span class="hljs-number">37</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>colnames<span class="hljs-punctuation">(</span>data_pro<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;gene symbol&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK_NPC-1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK_NPC-2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK_NPC-3&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;normal-1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;normal-2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;normal-3&#x27;</span><span class="hljs-punctuation">)</span><br>data_pro<span class="hljs-operator">$</span>`gene symbol` <span class="hljs-operator">&lt;-</span> str_split<span class="hljs-punctuation">(</span>data_pro<span class="hljs-operator">$</span>`gene symbol`<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;;&#x27;</span><span class="hljs-punctuation">,</span>simplify <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br>data_pro <span class="hljs-operator">&lt;-</span> data_pro<span class="hljs-punctuation">[</span><span class="hljs-operator">!</span>duplicated<span class="hljs-punctuation">(</span>data_pro<span class="hljs-operator">$</span>`gene symbol`<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br>data_pro <span class="hljs-operator">&lt;-</span> data_pro<span class="hljs-punctuation">[</span><span class="hljs-operator">!</span><span class="hljs-built_in">is.na</span><span class="hljs-punctuation">(</span>data_pro<span class="hljs-operator">$</span>`gene symbol`<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br>data_pro <span class="hljs-operator">&lt;-</span> column_to_rownames<span class="hljs-punctuation">(</span>data_pro<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;gene symbol&#x27;</span><span class="hljs-punctuation">)</span><br>data_pro <span class="hljs-operator">&lt;-</span> data_pro<span class="hljs-punctuation">[</span>rowSums<span class="hljs-punctuation">(</span><span class="hljs-operator">!</span><span class="hljs-built_in">is.na</span><span class="hljs-punctuation">(</span>data_pro<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">==</span><span class="hljs-number">6</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br><span class="hljs-comment"># deg</span><br>input_matrix <span class="hljs-operator">&lt;-</span> log2<span class="hljs-punctuation">(</span>data_pro<span class="hljs-punctuation">)</span><br>group <span class="hljs-operator">&lt;-</span> as.factor<span class="hljs-punctuation">(</span><span class="hljs-built_in">rep</span><span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;NK_NPC&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;normal&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>each<span class="hljs-operator">=</span><span class="hljs-number">3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>design <span class="hljs-operator">&lt;-</span> model.matrix<span class="hljs-punctuation">(</span><span class="hljs-operator">~</span><span class="hljs-number">0</span><span class="hljs-operator">+</span>group<span class="hljs-punctuation">)</span><br>colnames<span class="hljs-punctuation">(</span>design<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;NK_NPC&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;normal&#x27;</span><span class="hljs-punctuation">)</span><br>rownames<span class="hljs-punctuation">(</span>design<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> colnames<span class="hljs-punctuation">(</span>input_matrix<span class="hljs-punctuation">)</span><br>fit <span class="hljs-operator">&lt;-</span> lmFit<span class="hljs-punctuation">(</span>input_matrix<span class="hljs-punctuation">,</span>design<span class="hljs-punctuation">)</span><br>con.matrix <span class="hljs-operator">&lt;-</span> makeContrasts<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;NK_NPC-normal&#x27;</span><span class="hljs-punctuation">,</span>levels <span class="hljs-operator">=</span> design<span class="hljs-punctuation">)</span><br>fit2 <span class="hljs-operator">&lt;-</span> contrasts.fit<span class="hljs-punctuation">(</span>fit<span class="hljs-punctuation">,</span>contrasts <span class="hljs-operator">=</span> con.matrix<span class="hljs-punctuation">)</span><br>fit2 <span class="hljs-operator">&lt;-</span> eBayes<span class="hljs-punctuation">(</span>fit2<span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 差异筛选</span><br>options<span class="hljs-punctuation">(</span>digits <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">)</span><br>deg <span class="hljs-operator">&lt;-</span> topTable<span class="hljs-punctuation">(</span>fit2<span class="hljs-punctuation">,</span>n<span class="hljs-operator">=</span><span class="hljs-literal">Inf</span><span class="hljs-punctuation">)</span><br>up <span class="hljs-operator">&lt;-</span> <span class="hljs-punctuation">(</span>deg<span class="hljs-operator">$</span>logFC<span class="hljs-operator">&gt;</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><span class="hljs-operator">&amp;</span><span class="hljs-punctuation">(</span>deg<span class="hljs-operator">$</span>P.Val<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">)</span><br>down <span class="hljs-operator">&lt;-</span> <span class="hljs-punctuation">(</span>deg<span class="hljs-operator">$</span>logFC<span class="hljs-operator">&lt;</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">&amp;</span><span class="hljs-punctuation">(</span>deg<span class="hljs-operator">$</span>P.Val<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">)</span><br>change <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>up<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;up&#x27;</span><span class="hljs-punctuation">,</span>ifelse<span class="hljs-punctuation">(</span>down<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;down&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;none&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>deg <span class="hljs-operator">&lt;-</span> mutate<span class="hljs-punctuation">(</span>deg<span class="hljs-punctuation">,</span>change<span class="hljs-punctuation">)</span><br>deg <span class="hljs-operator">&lt;-</span> mutate<span class="hljs-punctuation">(</span>deg<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;p&#x27;</span> <span class="hljs-operator">=</span> <span class="hljs-operator">-</span>log10<span class="hljs-punctuation">(</span>deg<span class="hljs-operator">$</span>P.Val<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>top5 <span class="hljs-operator">&lt;-</span> rownames<span class="hljs-punctuation">(</span>top_n<span class="hljs-punctuation">(</span>deg<span class="hljs-punctuation">[</span>deg<span class="hljs-operator">$</span>change<span class="hljs-operator">==</span><span class="hljs-string">&#x27;up&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span>logFC<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>down5 <span class="hljs-operator">&lt;-</span> rownames<span class="hljs-punctuation">(</span>top_n<span class="hljs-punctuation">(</span>deg<span class="hljs-punctuation">[</span>deg<span class="hljs-operator">$</span>change<span class="hljs-operator">==</span><span class="hljs-string">&#x27;down&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-operator">-</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span>logFC<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>deg<span class="hljs-operator">$</span>label <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>rownames<span class="hljs-punctuation">(</span>deg<span class="hljs-punctuation">)</span> <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>top5<span class="hljs-punctuation">,</span>down5<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>rownames<span class="hljs-punctuation">(</span>deg<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-literal">NA</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># volcano</span><br>ggplot<span class="hljs-punctuation">(</span>deg<span class="hljs-punctuation">,</span>aes<span class="hljs-punctuation">(</span>x<span class="hljs-operator">=</span>logFC<span class="hljs-punctuation">,</span>y<span class="hljs-operator">=</span>p<span class="hljs-punctuation">,</span>color<span class="hljs-operator">=</span>change<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  geom_vline<span class="hljs-punctuation">(</span>xintercept <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>linetype<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span>color<span class="hljs-operator">=</span><span class="hljs-string">&#x27;gray&#x27;</span><span class="hljs-punctuation">,</span>linewidth<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  geom_vline<span class="hljs-punctuation">(</span>xintercept <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>linetype<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span>color<span class="hljs-operator">=</span><span class="hljs-string">&#x27;gray&#x27;</span><span class="hljs-punctuation">,</span>linewidth<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  geom_hline<span class="hljs-punctuation">(</span>yintercept <span class="hljs-operator">=</span> <span class="hljs-operator">-</span>log10<span class="hljs-punctuation">(</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>linetype<span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span>color<span class="hljs-operator">=</span><span class="hljs-string">&#x27;gray&#x27;</span><span class="hljs-punctuation">,</span>linewidth<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  geom_text_repel<span class="hljs-punctuation">(</span>aes<span class="hljs-punctuation">(</span>logFC<span class="hljs-punctuation">,</span>label<span class="hljs-operator">=</span>label<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                  max.overlaps <span class="hljs-operator">=</span> <span class="hljs-number">100000</span><span class="hljs-punctuation">,</span>size<span class="hljs-operator">=</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span>segment.color<span class="hljs-operator">=</span><span class="hljs-string">&#x27;black&#x27;</span><span class="hljs-punctuation">,</span><br>                  box.padding<span class="hljs-operator">=</span>unit<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;lines&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 差异蛋白pca</span><br>pca_data <span class="hljs-operator">&lt;-</span> data_pro<span class="hljs-punctuation">[</span>rownames<span class="hljs-punctuation">(</span>deg<span class="hljs-punctuation">[</span>deg<span class="hljs-operator">$</span>change<span class="hljs-operator">!=</span><span class="hljs-string">&#x27;none&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br>pca <span class="hljs-operator">&lt;-</span> prcomp<span class="hljs-punctuation">(</span>t<span class="hljs-punctuation">(</span>log2<span class="hljs-punctuation">(</span>pca_data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>scale. <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>xlab <span class="hljs-operator">&lt;-</span> paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;PCA_1(&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span>summary<span class="hljs-punctuation">(</span>pca<span class="hljs-punctuation">)</span><span class="hljs-operator">$</span>importance<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-operator">*</span><span class="hljs-number">100</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;%)&#x27;</span><span class="hljs-punctuation">)</span><br>ylab <span class="hljs-operator">&lt;-</span> paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;PCA_2(&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">round</span><span class="hljs-punctuation">(</span>summary<span class="hljs-punctuation">(</span>pca<span class="hljs-punctuation">)</span><span class="hljs-operator">$</span>importance<span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-operator">*</span><span class="hljs-number">100</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;%)&#x27;</span><span class="hljs-punctuation">)</span><br>ggplot<span class="hljs-punctuation">(</span>data.frame<span class="hljs-punctuation">(</span>pca<span class="hljs-operator">$</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>aes<span class="hljs-punctuation">(</span>x<span class="hljs-operator">=</span>PC1<span class="hljs-punctuation">,</span>y<span class="hljs-operator">=</span>PC2<span class="hljs-punctuation">,</span>color<span class="hljs-operator">=</span>group<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>stat_ellipse<span class="hljs-punctuation">(</span>level <span class="hljs-operator">=</span> <span class="hljs-number">0.95</span><span class="hljs-punctuation">,</span> show.legend <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span> <br>  labs<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> xlab<span class="hljs-punctuation">,</span>y <span class="hljs-operator">=</span> ylab<span class="hljs-punctuation">,</span>title <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;PCA Analysis&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  theme<span class="hljs-punctuation">(</span>plot.title <span class="hljs-operator">=</span> element_text<span class="hljs-punctuation">(</span>hjust <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  guides<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> guide_legend<span class="hljs-punctuation">(</span>title <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Group&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># heatmap</span><br>NK_cytotoxicity <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;PRKCB&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;PTPN11&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;LCK&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ITGAL&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;PIK3CB&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;MAPK3&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CASP3&#x27;</span><span class="hljs-punctuation">)</span><br>pheatmap<span class="hljs-punctuation">(</span>data_pro<span class="hljs-punctuation">[</span>NK_cytotoxicity<span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>scale <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;row&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># KEGG</span><br>kegg_id <span class="hljs-operator">&lt;-</span> bitr<span class="hljs-punctuation">(</span>rownames<span class="hljs-punctuation">(</span>deg<span class="hljs-punctuation">[</span>deg<span class="hljs-operator">$</span>change<span class="hljs-operator">!=</span><span class="hljs-string">&#x27;none&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>fromType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span>toType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">)</span><br>kegg <span class="hljs-operator">&lt;-</span> enrichKEGG<span class="hljs-punctuation">(</span>kegg_id<span class="hljs-operator">$</span>ENTREZID<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;hsa&#x27;</span><span class="hljs-punctuation">,</span>keyType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;kegg&#x27;</span><span class="hljs-punctuation">)</span><br>kegg <span class="hljs-operator">&lt;-</span> setReadable<span class="hljs-punctuation">(</span>kegg<span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">,</span>keyType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">)</span><br>fc <span class="hljs-operator">&lt;-</span> deg<span class="hljs-punctuation">[</span>deg<span class="hljs-operator">$</span>change<span class="hljs-operator">!=</span><span class="hljs-string">&#x27;none&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;logFC&#x27;</span><span class="hljs-punctuation">]</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>fc<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> rownames<span class="hljs-punctuation">(</span>deg<span class="hljs-punctuation">[</span>deg<span class="hljs-operator">$</span>change<span class="hljs-operator">!=</span><span class="hljs-string">&#x27;none&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>cnetplot<span class="hljs-punctuation">(</span>kegg<span class="hljs-punctuation">,</span>color.params <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>foldChange <span class="hljs-operator">=</span> fc<span class="hljs-punctuation">,</span>edge<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>rm<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span> <span class="hljs-operator">=</span> ls<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>gc<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>
<img src="/img/Fig1.A_Volcano.png" srcset="/img/loading.gif" lazyload alt="Fig1.A_Volcano" style="zoom:50%;" />
<p>Fig.1.A    NK-NPC蛋白质组学差异分析结果的火山图，与正常组相比，NK-NPC组有76种蛋白上调，85种蛋白下调，并标记了几个有趣的蛋白</p>
<img src="/img/Fig1.B_PCA.png" srcset="/img/loading.gif" lazyload alt="Fig1.B_PCA" style="zoom:50%;" />
<p>Fig.1.B  主成分分析（PCA）可很好地区分3个NK-NPC和3个正常鼻咽组织之间的差异表达蛋白。</p>
<img src="/img/Fig1.C_KEGG.png" srcset="/img/loading.gif" lazyload style="zoom:33%;" />
<p>Fig.1.C  对 161 种差异表达蛋白进行 KEGG 富集分析。</p>
<img src="/img/Fig1.D_Heatmap.png" srcset="/img/loading.gif" lazyload alt="Fig1.D_Heatmap" style="zoom:50%;" />
<p>Fig.1.D  蛋白热图显示，富集在自然杀伤细胞介导的细胞毒性通路中的DE蛋白在NK-NPC组中显著下调，包括PRKCB、PTPN11、LCK、ITGAL、PIK3CB、CASP3和MAPK3。</p>
<h3 id="4-3-GSE162025的scRNA-seq分析">4.3  GSE162025的scRNA-seq分析</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 数据读取</span><br>setwd<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;C:\\Users\\汐\\Desktop\\R语言复现\\NK细胞耗竭和肿瘤细胞进化轨迹&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 162025</span><br>data_162025 <span class="hljs-operator">&lt;-</span> fread<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;rawdata/GSE162025_RAW/Tumor/GSM4929846_NPC_SC_1802_Tumor_count.csv.gz&#x27;</span><span class="hljs-punctuation">)</span><br><br>filename <span class="hljs-operator">&lt;-</span> paste<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;rawdata/GSE162025_RAW/Tumor/&#x27;</span><span class="hljs-punctuation">,</span>list.files<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;rawdata/GSE162025_RAW/Tumor/&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>sep <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-punctuation">)</span><br>data_162025List <span class="hljs-operator">&lt;-</span> lapply<span class="hljs-punctuation">(</span>filename<span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>  obj <span class="hljs-operator">&lt;-</span> CreateSeuratObject<span class="hljs-punctuation">(</span>counts <span class="hljs-operator">=</span> read.csv<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                            <span class="hljs-comment"># project = paste(str_split(str_split(x,&#x27;/&#x27;)[[1]][3],&#x27;_&#x27;)[[1]][2:4],collapse = &#x27;_&#x27;),</span><br>                            min.cells <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> min.features <span class="hljs-operator">=</span> <span class="hljs-number">200</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br>data_162025 <span class="hljs-operator">&lt;-</span> merge<span class="hljs-punctuation">(</span>data_162025List<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>data_162025List<span class="hljs-punctuation">[</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>add.cell.ids <span class="hljs-operator">=</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>data_162025List<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>data_162025<span class="hljs-operator">$</span>orig.ident <span class="hljs-operator">&lt;-</span> apply<span class="hljs-punctuation">(</span>str_split<span class="hljs-punctuation">(</span>rownames<span class="hljs-punctuation">(</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;_&#x27;</span><span class="hljs-punctuation">,</span>simplify <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">3</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                                <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                                <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span>paste0<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span>collapse <span class="hljs-operator">=</span><span class="hljs-string">&#x27;_&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">)</span><br>saveRDS<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;data_162025.RDS&#x27;</span><span class="hljs-punctuation">)</span><br>data_162025 <span class="hljs-operator">&lt;-</span> readRDS<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;data_162025.RDS&#x27;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># QC</span><br><span class="hljs-comment">#VlnPlot(data_162025,features = &#x27;nFeature_RNA&#x27;,group.by = &#x27;orig.ident&#x27;,pt.size = 0)</span><br>data_162025 <span class="hljs-operator">&lt;-</span> subset<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>subset <span class="hljs-operator">=</span> nFeature_RNA<span class="hljs-operator">&gt;</span><span class="hljs-number">200</span> <span class="hljs-operator">&amp;</span> nFeature_RNA<span class="hljs-operator">&lt;</span><span class="hljs-number">4000</span><span class="hljs-punctuation">)</span><br><br>data_162025 <span class="hljs-operator">&lt;-</span> PercentageFeatureSet<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>pattern <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;^MT&#x27;</span><span class="hljs-punctuation">,</span>col.name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;percent.MT&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#VlnPlot(data_162025,features = &#x27;percent.MT&#x27;,group.by = &#x27;orig.ident&#x27;,pt.size = 0)</span><br>data_162025 <span class="hljs-operator">&lt;-</span> subset<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>subset <span class="hljs-operator">=</span> percent.MT<span class="hljs-operator">&lt;</span><span class="hljs-number">5</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 降维</span><br>data_162025 <span class="hljs-operator">&lt;-</span> NormalizeData<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">)</span><br>data_162025 <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">)</span><br>data_162025 <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">)</span><br>data_162025 <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">)</span><br><span class="hljs-comment">#ElbowPlot(data_162025,ndims = 30)</span><br><span class="hljs-comment"># 分群</span><br>data_162025 <span class="hljs-operator">&lt;-</span> RunTSNE<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;pca&#x27;</span><span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#DimPlot(data_162025,reduction = &#x27;tsne&#x27;,label = T,group.by = &#x27;orig.ident&#x27;)</span><br>data_162025 <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br>data_162025 <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">#DimPlot(data_162025,reduction = &#x27;tsne&#x27;,label = T,group.by = &#x27;seurat_clusters&#x27;)</span><br><br><span class="hljs-comment"># 注释</span><br><span class="hljs-comment"># T cell [&#x27;PTPRC&#x27;,&#x27;CD3D&#x27;,&#x27;CD8A&#x27;]---[0,1,3,4,5,7,8,9,10,11,12,13]</span><br><span class="hljs-comment"># NK cell [&#x27;PTPRC&#x27;,&#x27;NKG7&#x27;,&#x27;CD96&#x27;,&#x27;KLRC1&#x27;,&#x27;NCAM1&#x27;]---[7,11] [0,1,5,7,10,11,13]</span><br><span class="hljs-comment"># Myeloid cells [&#x27;CD14&#x27;, &#x27;CD68&#x27;, &#x27;CD163&#x27;, &#x27;ITGAX&#x27;,&#x27;FCGR3A&#x27;]---[15,18,19]</span><br><span class="hljs-comment"># Epithelial cells [&#x27;EPCAM&#x27;, &#x27;KRT5&#x27;, &#x27;TP63&#x27;, &#x27;SSTR2&#x27;]---[16]</span><br><span class="hljs-comment"># B cell [&#x27;CD19&#x27;, &#x27;MS4A1&#x27;, &#x27;CD79A&#x27;]---[2,6,14,17]</span><br><span class="hljs-comment"># mast cell [&#x27;TPSAB1&#x27;,&#x27;TPSB2&#x27;,&#x27;CPA3&#x27;] --- [20]</span><br><br><br>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>seurat_clusters <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span><span class="hljs-number">7</span><span class="hljs-punctuation">,</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span><span class="hljs-number">9</span><span class="hljs-punctuation">,</span><span class="hljs-number">10</span><span class="hljs-punctuation">,</span><span class="hljs-number">11</span><span class="hljs-punctuation">,</span><span class="hljs-number">12</span><span class="hljs-punctuation">,</span><span class="hljs-number">13</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;T cells&#x27;</span><br>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>seurat_clusters <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">7</span><span class="hljs-punctuation">,</span><span class="hljs-number">11</span><span class="hljs-punctuation">,</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;NK cell&#x27;</span><br>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>seurat_clusters <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span><span class="hljs-number">18</span><span class="hljs-punctuation">,</span><span class="hljs-number">19</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;Myeloid cells&#x27;</span><br>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>seurat_clusters <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">16</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;Epithelial cells&#x27;</span><br>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">[</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>seurat_clusters <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">6</span><span class="hljs-punctuation">,</span><span class="hljs-number">14</span><span class="hljs-punctuation">,</span><span class="hljs-number">17</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;B cells&#x27;</span><br>saveRDS<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;data_162025_type.RDS&#x27;</span><span class="hljs-punctuation">)</span><br>data_162025 <span class="hljs-operator">&lt;-</span> readRDS<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;data_162025_type.RDS&#x27;</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 细胞类型占比堆叠柱状图</span><br>cell_ratio <span class="hljs-operator">&lt;-</span> matrix<span class="hljs-punctuation">(</span>nrow <span class="hljs-operator">=</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>type<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                     ncol <span class="hljs-operator">=</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>unique<span class="hljs-punctuation">(</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>orig.ident<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>cell_ratio <span class="hljs-operator">&lt;-</span> as.data.frame<span class="hljs-punctuation">(</span>cell_ratio<span class="hljs-punctuation">,</span>row.names <span class="hljs-operator">=</span> unique<span class="hljs-punctuation">(</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>type<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>colnames<span class="hljs-punctuation">(</span>cell_ratio<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> unique<span class="hljs-punctuation">(</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>orig.ident<span class="hljs-punctuation">)</span><br>table<span class="hljs-punctuation">(</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>orig.ident<span class="hljs-punctuation">)</span><br><span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>cell <span class="hljs-keyword">in</span> unique<span class="hljs-punctuation">(</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>type<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>  cell_count <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">sum</span><span class="hljs-punctuation">(</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>type<span class="hljs-operator">==</span>cell<span class="hljs-punctuation">)</span><br>  <span class="hljs-keyword">for</span> <span class="hljs-punctuation">(</span>sample <span class="hljs-keyword">in</span> unique<span class="hljs-punctuation">(</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>orig.ident<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span><br>    cell_ratio<span class="hljs-punctuation">[</span>cell<span class="hljs-punctuation">,</span>sample<span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">sum</span><span class="hljs-punctuation">(</span>data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>type<span class="hljs-operator">==</span>cell <span class="hljs-operator">&amp;</span> data_162025<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>orig.ident<span class="hljs-operator">==</span>sample<span class="hljs-punctuation">)</span> <span class="hljs-operator">/</span> cell_count<br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br>cell_ratio <span class="hljs-operator">&lt;-</span> rownames_to_column<span class="hljs-punctuation">(</span>cell_ratio<span class="hljs-punctuation">,</span>var <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;cell_type&#x27;</span><span class="hljs-punctuation">)</span><br>cell_ratio <span class="hljs-operator">&lt;-</span> pivot_longer<span class="hljs-punctuation">(</span>cell_ratio<span class="hljs-punctuation">,</span>cols <span class="hljs-operator">=</span> <span class="hljs-operator">-</span>cell_type<span class="hljs-punctuation">,</span>names_to <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sample&#x27;</span><span class="hljs-punctuation">)</span><br>ggplot<span class="hljs-punctuation">(</span>cell_ratio<span class="hljs-punctuation">,</span> aes<span class="hljs-punctuation">(</span> x <span class="hljs-operator">=</span> cell_type<span class="hljs-punctuation">,</span> weight <span class="hljs-operator">=</span> value<span class="hljs-punctuation">,</span> fill <span class="hljs-operator">=</span> sample<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span><br>  geom_bar<span class="hljs-punctuation">(</span> position <span class="hljs-operator">=</span> <span class="hljs-string">&quot;stack&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-operator">+</span>coord_flip<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>
<img src="/img/Fig2.A.png" srcset="/img/loading.gif" lazyload style="zoom:20%;" />
<p>Fig.2.A  NK-NPC单细胞图谱。通过降维和聚类 79,000 个细胞获得了 19 个簇。</p>
<img src="/img/Fig2.B.png" srcset="/img/loading.gif" lazyload style="zoom:25%;" />
<p>Fig.2.B   19个簇通过其各自的标记基因被识别为不同类型的细胞：上皮细胞、T细胞、NK细胞、髓样细胞和B细胞。</p>
<img src="/img/Fig2.D.png" srcset="/img/loading.gif" lazyload style="zoom:35%;" />
<p>Fig.2.D  10 个样本中每个样本中细胞类型比例的条形图</p>
<h3 id="4-4-NK细胞亚型分析和衰竭情况">4.4  NK细胞亚型分析和衰竭情况</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 对NK细胞继续细分</span><br>NK_subtype <span class="hljs-operator">&lt;-</span> subset<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>subset<span class="hljs-operator">=</span> type <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;NK cell&#x27;</span><span class="hljs-punctuation">)</span><br>NK_subtype <span class="hljs-operator">&lt;-</span> NormalizeData<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">)</span><br>NK_subtype <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">)</span><br>NK_subtype <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">)</span><br>NK_subtype <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">)</span><br>ElbowPlot<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">,</span>ndims <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">)</span><br>NK_subtype <span class="hljs-operator">&lt;-</span> RunTSNE<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;pca&#x27;</span><span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">)</span><br>NK_subtype <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br>NK_subtype <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">,</span>resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.15</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;seurat_clusters&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>NK_subtype<span class="hljs-operator">$</span>type <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-operator">$</span>seurat_clusters<span class="hljs-operator">==</span><span class="hljs-string">&#x27;0&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK1&#x27;</span><span class="hljs-punctuation">,</span><br>                          ifelse<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-operator">$</span>seurat_clusters<span class="hljs-operator">==</span><span class="hljs-string">&#x27;1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK2&#x27;</span><span class="hljs-punctuation">,</span><br>                                 ifelse<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-operator">$</span>seurat_clusters<span class="hljs-operator">==</span><span class="hljs-string">&#x27;2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK3&#x27;</span><span class="hljs-punctuation">,</span><br>                                        ifelse<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-operator">$</span>seurat_clusters<span class="hljs-operator">==</span><span class="hljs-string">&#x27;3&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK4&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;mast&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># scRNA volcano</span><br>NK_deg <span class="hljs-operator">&lt;-</span> FindAllMarkers<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">)</span><br>NK_deg<span class="hljs-operator">$</span>cluster <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>NK_deg<span class="hljs-operator">$</span>cluster<span class="hljs-operator">==</span><span class="hljs-string">&#x27;0&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK1&#x27;</span><span class="hljs-punctuation">,</span><br>                         ifelse<span class="hljs-punctuation">(</span>NK_deg<span class="hljs-operator">$</span>cluster<span class="hljs-operator">==</span><span class="hljs-string">&#x27;1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK2&#x27;</span><span class="hljs-punctuation">,</span><br>                                ifelse<span class="hljs-punctuation">(</span>NK_deg<span class="hljs-operator">$</span>cluster<span class="hljs-operator">==</span><span class="hljs-string">&#x27;2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK3&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NK4&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>jjVolcano<span class="hljs-punctuation">(</span>NK_deg<span class="hljs-punctuation">)</span><br>saveRDS<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">,</span>file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;NK_subtype.RDS&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># GSEA</span><br>NK_1df <span class="hljs-operator">&lt;-</span> NK_deg<span class="hljs-punctuation">[</span>NK_deg<span class="hljs-operator">$</span>cluster<span class="hljs-operator">==</span><span class="hljs-string">&#x27;NK1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br><br>NK_1_up <span class="hljs-operator">&lt;-</span> NK_1df<span class="hljs-punctuation">[</span>NK_1df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&gt;</span><span class="hljs-number">0.25</span> <span class="hljs-operator">&amp;</span> NK_1df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;avg_log2FC&#x27;</span><span class="hljs-punctuation">]</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>NK_1_up<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> bitr<span class="hljs-punctuation">(</span>NK_1df<span class="hljs-punctuation">[</span>NK_1df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&gt;</span><span class="hljs-number">0.25</span> <span class="hljs-operator">&amp;</span> NK_1df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;gene&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                       fromType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span>toType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">]</span><br>NK_1_up <span class="hljs-operator">&lt;-</span> sort<span class="hljs-punctuation">(</span>NK_1_up<span class="hljs-punctuation">,</span>decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>NK_1_up_gse <span class="hljs-operator">&lt;-</span> gseKEGG<span class="hljs-punctuation">(</span>NK_1_up<span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>NK_1_up_gse<span class="hljs-operator">@</span>result<span class="hljs-punctuation">)</span><br><br>NK_1_down <span class="hljs-operator">&lt;-</span> NK_1df<span class="hljs-punctuation">[</span>NK_1df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&lt;</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.25</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span> NK_1df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;avg_log2FC&#x27;</span><span class="hljs-punctuation">]</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>NK_1_down<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> bitr<span class="hljs-punctuation">(</span>NK_1df<span class="hljs-punctuation">[</span>NK_1df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&lt;</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.25</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span> NK_1df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;gene&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                         fromType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span>toType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">]</span><br>NK_1_down <span class="hljs-operator">&lt;-</span> sort<span class="hljs-punctuation">(</span>NK_1_down<span class="hljs-punctuation">,</span>decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>NK_1_down_gse <span class="hljs-operator">&lt;-</span> gseKEGG<span class="hljs-punctuation">(</span>NK_1_down<span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>NK_1_down_gse<span class="hljs-operator">@</span>result<span class="hljs-punctuation">)</span><br><br>gseaplot2<span class="hljs-punctuation">(</span>NK_1_up_gse<span class="hljs-punctuation">,</span>geneSetID <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">6</span><span class="hljs-punctuation">,</span>title <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;NK1&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">############ NK2</span><br>NK_2df <span class="hljs-operator">&lt;-</span> NK_deg<span class="hljs-punctuation">[</span>NK_deg<span class="hljs-operator">$</span>cluster<span class="hljs-operator">==</span><span class="hljs-string">&#x27;NK2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br><br>NK_2_up <span class="hljs-operator">&lt;-</span> NK_2df<span class="hljs-punctuation">[</span>NK_2df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&gt;</span><span class="hljs-number">0.25</span> <span class="hljs-operator">&amp;</span> NK_2df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;avg_log2FC&#x27;</span><span class="hljs-punctuation">]</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>NK_2_up<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> bitr<span class="hljs-punctuation">(</span>NK_2df<span class="hljs-punctuation">[</span>NK_2df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&gt;</span><span class="hljs-number">0.25</span> <span class="hljs-operator">&amp;</span> NK_2df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;gene&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                       fromType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span>toType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">]</span><br>NK_2_up <span class="hljs-operator">&lt;-</span> sort<span class="hljs-punctuation">(</span>NK_2_up<span class="hljs-punctuation">,</span>decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>NK_2_up_gse <span class="hljs-operator">&lt;-</span> gseKEGG<span class="hljs-punctuation">(</span>NK_2_up<span class="hljs-punctuation">)</span><br><br>NK_2_down <span class="hljs-operator">&lt;-</span> NK_2df<span class="hljs-punctuation">[</span>NK_2df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&lt;</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.25</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span> NK_2df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;avg_log2FC&#x27;</span><span class="hljs-punctuation">]</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>NK_2_down<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> bitr<span class="hljs-punctuation">(</span>NK_2df<span class="hljs-punctuation">[</span>NK_2df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&lt;</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.25</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span> NK_2df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;gene&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                         fromType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span>toType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">]</span><br>NK_2_down <span class="hljs-operator">&lt;-</span> sort<span class="hljs-punctuation">(</span>NK_2_down<span class="hljs-punctuation">,</span>decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>NK_2_down_gse <span class="hljs-operator">&lt;-</span> gseKEGG<span class="hljs-punctuation">(</span>NK_2_down<span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>NK_2_down_gse<span class="hljs-operator">@</span>result<span class="hljs-punctuation">)</span><br><br>gseaplot2<span class="hljs-punctuation">(</span>NK_2_down_gse<span class="hljs-punctuation">,</span>geneSetID <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span>title <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;NK2&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">############ NK3</span><br>NK_3df <span class="hljs-operator">&lt;-</span> NK_deg<span class="hljs-punctuation">[</span>NK_deg<span class="hljs-operator">$</span>cluster<span class="hljs-operator">==</span><span class="hljs-string">&#x27;NK3&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br><br>NK_3_up <span class="hljs-operator">&lt;-</span> NK_3df<span class="hljs-punctuation">[</span>NK_3df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&gt;</span><span class="hljs-number">0.25</span> <span class="hljs-operator">&amp;</span> NK_3df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;avg_log2FC&#x27;</span><span class="hljs-punctuation">]</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>NK_3_up<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> bitr<span class="hljs-punctuation">(</span>NK_3df<span class="hljs-punctuation">[</span>NK_3df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&gt;</span><span class="hljs-number">0.25</span> <span class="hljs-operator">&amp;</span> NK_3df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;gene&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                       fromType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span>toType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">]</span><br>NK_3_up <span class="hljs-operator">&lt;-</span> sort<span class="hljs-punctuation">(</span>NK_3_up<span class="hljs-punctuation">,</span>decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>NK_3_up_gse <span class="hljs-operator">&lt;-</span> gseKEGG<span class="hljs-punctuation">(</span>NK_3_up<span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>NK_3_up_gse<span class="hljs-operator">@</span>result<span class="hljs-punctuation">)</span><br><br>NK_3_down <span class="hljs-operator">&lt;-</span> NK_3df<span class="hljs-punctuation">[</span>NK_3df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&lt;</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.25</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span> NK_3df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;avg_log2FC&#x27;</span><span class="hljs-punctuation">]</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>NK_3_down<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> bitr<span class="hljs-punctuation">(</span>NK_3df<span class="hljs-punctuation">[</span>NK_3df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&lt;</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.25</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span> NK_3df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;gene&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                         fromType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span>toType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">]</span><br>NK_3_down <span class="hljs-operator">&lt;-</span> sort<span class="hljs-punctuation">(</span>NK_3_down<span class="hljs-punctuation">,</span>decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>NK_3_down_gse <span class="hljs-operator">&lt;-</span> gseKEGG<span class="hljs-punctuation">(</span>NK_3_down<span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>NK_3_down_gse<span class="hljs-operator">@</span>result<span class="hljs-punctuation">)</span><br>gseaplot2<span class="hljs-punctuation">(</span>NK_3_up_gse<span class="hljs-punctuation">,</span>geneSetID <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>title <span class="hljs-operator">=</span> NK_3_up_gse<span class="hljs-operator">@</span>result<span class="hljs-operator">$</span>Description<span class="hljs-punctuation">)</span><br>gseaplot2<span class="hljs-punctuation">(</span>NK_3_down_gse<span class="hljs-punctuation">,</span>geneSetID <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span>title <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;NK3&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment">############ NK4</span><br>NK_4df <span class="hljs-operator">&lt;-</span> NK_deg<span class="hljs-punctuation">[</span>NK_deg<span class="hljs-operator">$</span>cluster<span class="hljs-operator">==</span><span class="hljs-string">&#x27;NK4&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br><br>NK_4_up <span class="hljs-operator">&lt;-</span> NK_4df<span class="hljs-punctuation">[</span>NK_4df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&gt;</span><span class="hljs-number">0.25</span> <span class="hljs-operator">&amp;</span> NK_4df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;avg_log2FC&#x27;</span><span class="hljs-punctuation">]</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>NK_4_up<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> bitr<span class="hljs-punctuation">(</span>NK_4df<span class="hljs-punctuation">[</span>NK_4df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&gt;</span><span class="hljs-number">0.25</span> <span class="hljs-operator">&amp;</span> NK_4df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;gene&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                       fromType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span>toType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">]</span><br>NK_4_up <span class="hljs-operator">&lt;-</span> sort<span class="hljs-punctuation">(</span>NK_4_up<span class="hljs-punctuation">,</span>decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>NK_4_up_gse <span class="hljs-operator">&lt;-</span> gseKEGG<span class="hljs-punctuation">(</span>NK_4_up<span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>NK_4_up_gse<span class="hljs-operator">@</span>result<span class="hljs-punctuation">)</span><br><br>NK_4_down <span class="hljs-operator">&lt;-</span> NK_4df<span class="hljs-punctuation">[</span>NK_4df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&lt;</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.25</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span> NK_4df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;avg_log2FC&#x27;</span><span class="hljs-punctuation">]</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>NK_4_down<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> bitr<span class="hljs-punctuation">(</span>NK_4df<span class="hljs-punctuation">[</span>NK_4df<span class="hljs-operator">$</span>avg_log2FC<span class="hljs-operator">&lt;</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.25</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">&amp;</span> NK_4df<span class="hljs-operator">$</span>p_val_adj<span class="hljs-operator">&lt;</span><span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;gene&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                         fromType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span>toType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">]</span><br>NK_4_down <span class="hljs-operator">&lt;-</span> sort<span class="hljs-punctuation">(</span>NK_4_down<span class="hljs-punctuation">,</span>decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>NK_4_down_gse <span class="hljs-operator">&lt;-</span> gseKEGG<span class="hljs-punctuation">(</span>NK_4_down<span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>NK_4_down_gse<span class="hljs-operator">@</span>result<span class="hljs-punctuation">)</span><br><br>gseaplot2<span class="hljs-punctuation">(</span>NK_4_down_gse<span class="hljs-punctuation">,</span>geneSetID <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>
<img src="/img/Fig3.A.png" srcset="/img/loading.gif" lazyload style="zoom:40%;" />
<p>Fig.3.A  通过NK细胞的降维和聚类获得NK1-4细胞亚群</p>
<img src="/img/Fig3.B.png" srcset="/img/loading.gif" lazyload style="zoom:20%;" />
<p>Fig.3.B  scRNA volcano</p>
<img src="/img/Fig3.C.png" srcset="/img/loading.gif" lazyload style="zoom:30%;" />
<p>Fig.3.C  GSEA结果显示，NK1亚群激活了自然杀伤细胞介导的细胞毒性。NK2，NK3不再重复复现过程。</p>
<h3 id="4-5-NK细胞亚群细胞通讯分析">4.5  NK细胞亚群细胞通讯分析</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs R">devtools<span class="hljs-operator">::</span>install_github<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;immunogenomics/presto&#x27;</span><span class="hljs-punctuation">)</span><br>rm<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span> <span class="hljs-operator">=</span> ls<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>NK_subtype <span class="hljs-operator">&lt;-</span> readRDS<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;NK_subtype.RDS&#x27;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># cellchat</span><br><span class="hljs-comment"># Step1.创建cellchat对象</span><br>data.input <span class="hljs-operator">&lt;-</span> NK_subtype<span class="hljs-operator">@</span>assays<span class="hljs-operator">$</span>RNA<span class="hljs-operator">@</span>data<br>meta.data <span class="hljs-operator">&lt;-</span> NK_subtype<span class="hljs-operator">@</span>meta.data<br><br>cellchat <span class="hljs-operator">&lt;-</span> createCellChat<span class="hljs-punctuation">(</span>object<span class="hljs-operator">=</span>data.input<span class="hljs-punctuation">,</span><br>                           meta <span class="hljs-operator">=</span> meta.data<span class="hljs-punctuation">,</span><br>                           group.by<span class="hljs-operator">=</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> addMeta<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>meta <span class="hljs-operator">=</span> meta.data<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># Step2.加载CellChatDB数据库</span><br>cellchatDB <span class="hljs-operator">&lt;-</span> CellChatDB.human<br>cellchat<span class="hljs-operator">@</span>DB <span class="hljs-operator">&lt;-</span> cellchatDB<br><br><span class="hljs-comment"># Step3.处理表达数据</span><br>cellchat <span class="hljs-operator">&lt;-</span> subsetData<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> identifyOverExpressedGenes<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>do.fast <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> identifyOverExpressedInteractions<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># Step4.计算通讯概率，推断细胞通讯网络</span><br>cellchat <span class="hljs-operator">&lt;-</span> computeCommunProb<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>population.size <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> filterCommunication<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>min.cells <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># Step5. 提取预测的细胞通讯网络为data frame</span><br>df.net <span class="hljs-operator">&lt;-</span> subsetCommunication<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">)</span><br>df.pathway <span class="hljs-operator">&lt;-</span> subsetCommunication<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>slot.name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;netP&#x27;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># Step6. 在信号通路水平推断细胞通讯</span><br>cellchat <span class="hljs-operator">&lt;-</span> computeCommunProbPathway<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">)</span><br><span class="hljs-comment"># Step7. 计算加和的cell-cell通讯网络</span><br>cellchat <span class="hljs-operator">&lt;-</span> aggregateNet<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">)</span><br>saveRDS<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;cellchat.RDS&#x27;</span><span class="hljs-punctuation">)</span><br><br>levels<span class="hljs-punctuation">(</span>cellchat<span class="hljs-operator">@</span>idents<span class="hljs-punctuation">)</span><br>netVisual_bubble<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span> sources.use <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                 targets.use <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>remove.isolate <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>
<img src="/img/Fig3.F.png" srcset="/img/loading.gif" lazyload style="zoom:33%;" />
<p>Fig.3.F  肥大细胞和 NK1-3 亚群之间的细胞间相互作用。</p>
<h3 id="4-6-NK细胞耗竭标志物的表达">4.6  NK细胞耗竭标志物的表达</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs R">VlnPlot<span class="hljs-punctuation">(</span>NK_subtype<span class="hljs-punctuation">,</span>features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;KLRF1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;IL7R&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ZNF683&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;TPSAB1&#x27;</span><span class="hljs-punctuation">,</span><br>                                <span class="hljs-string">&#x27;LGALS9&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CD44&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;PTPRC&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HAVCR2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NKG7&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;TIGIT&#x27;</span><span class="hljs-punctuation">,</span><br>                                <span class="hljs-string">&#x27;LAG3&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;CTLA4&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">,</span>pt.size <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>
<img src="/img/Fig3.G.png" srcset="/img/loading.gif" lazyload style="zoom:20%;" />
<p>Fig.3.G  细胞耗竭标志物的表达：NK1-3亚群中HAVCR2、TIGIT、LAG3和CTLA4，其中NK3的TIGIT和LAG3表达最高，HAVCR2和CTLA4的部分表达。此外，NK3 的 ZNF683 表达最高。</p>
<h3 id="4-7-GSE150825鼻炎淋巴增生分析">4.7  GSE150825鼻炎淋巴增生分析</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs R">rm<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span> <span class="hljs-operator">=</span> ls<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>gc<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>setwd<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;C:\\Users\\汐\\Desktop\\R语言复现\\NK细胞耗竭和肿瘤细胞进化轨迹&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 150825,这一步需去前缀GSE150825_</span><br>data_150825 <span class="hljs-operator">&lt;-</span> CreateSeuratObject<span class="hljs-punctuation">(</span>counts <span class="hljs-operator">=</span> Read10X<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;rawdata/GSE150825_RAW/rawdata/&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                                  min.cells <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> min.features <span class="hljs-operator">=</span> <span class="hljs-number">200</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>data_150825<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 降维</span><br>data_150825 <span class="hljs-operator">&lt;-</span> NormalizeData<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">)</span><br>data_150825 <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">)</span><br>data_150825 <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">)</span><br>data_150825 <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">)</span><br>ElbowPlot<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">,</span>ndims <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 分群</span><br>data_150825 <span class="hljs-operator">&lt;-</span> RunTSNE<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;pca&#x27;</span><span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>data_150825 <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br>data_150825 <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">,</span>resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.6</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;seurat_clusters&#x27;</span><span class="hljs-punctuation">)</span><br><br>DotPlot<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">,</span>features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;CD14&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;CD68&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;CD163&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&#x27;ITGAX&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;FCGR3A&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>cell_type <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span>cluster <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-operator">:</span><span class="hljs-number">19</span><span class="hljs-punctuation">,</span>type <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-operator">:</span><span class="hljs-number">19</span><span class="hljs-punctuation">)</span><br>cell_type<span class="hljs-punctuation">[</span>cell_type<span class="hljs-operator">$</span>cluster <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span><span class="hljs-number">7</span><span class="hljs-punctuation">,</span><span class="hljs-number">9</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;T cells&#x27;</span><br>cell_type<span class="hljs-punctuation">[</span>cell_type<span class="hljs-operator">$</span>cluster <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span><span class="hljs-number">7</span><span class="hljs-punctuation">,</span><span class="hljs-number">11</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;NK cell&#x27;</span><br>cell_type<span class="hljs-punctuation">[</span>cell_type<span class="hljs-operator">$</span>cluster <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span><span class="hljs-number">18</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;Myeloid cells&#x27;</span><br>cell_type<span class="hljs-punctuation">[</span>cell_type<span class="hljs-operator">$</span>cluster <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">13</span><span class="hljs-punctuation">,</span><span class="hljs-number">17</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;Epithelial cells&#x27;</span><br>cell_type<span class="hljs-punctuation">[</span>cell_type<span class="hljs-operator">$</span>cluster <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">6</span><span class="hljs-punctuation">,</span><span class="hljs-number">10</span><span class="hljs-punctuation">,</span><span class="hljs-number">12</span><span class="hljs-punctuation">,</span><span class="hljs-number">16</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;B cells&#x27;</span><br>cell_type<span class="hljs-punctuation">[</span>cell_type<span class="hljs-operator">$</span>cluster <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">6</span><span class="hljs-punctuation">,</span><span class="hljs-number">19</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;plasma cells&#x27;</span><br>cell_type<span class="hljs-punctuation">[</span>cell_type<span class="hljs-operator">$</span>cluster <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">14</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;mast cells&#x27;</span><br>cell_type<span class="hljs-punctuation">[</span>cell_type<span class="hljs-operator">$</span>cluster <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">15</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">&lt;-</span> <span class="hljs-string">&#x27;fiberblast&#x27;</span><br><br>data_150825<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>type <span class="hljs-operator">&lt;-</span> unlist<span class="hljs-punctuation">(</span>lapply<span class="hljs-punctuation">(</span>data_150825<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>seurat_clusters<span class="hljs-punctuation">,</span><span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span>cell_type<span class="hljs-punctuation">[</span>cell_type<span class="hljs-operator">$</span>cluster<span class="hljs-operator">==</span>x<span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br><br>data_150825_nk <span class="hljs-operator">&lt;-</span> subset<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">,</span>subset<span class="hljs-operator">=</span> type <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;NK cell&#x27;</span><span class="hljs-punctuation">)</span><br><br>data_150825_nk <span class="hljs-operator">&lt;-</span> NormalizeData<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">)</span><br>data_150825_nk <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">)</span><br>data_150825_nk <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">)</span><br>data_150825_nk <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">)</span><br>ElbowPlot<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">,</span>ndims <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">)</span><br>data_150825_nk <span class="hljs-operator">&lt;-</span> RunTSNE<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;pca&#x27;</span><span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">)</span><br>data_150825_nk <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br>data_150825_nk <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">,</span>resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;seurat_clusters&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>data_150825_nk<span class="hljs-operator">$</span>type <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-operator">$</span>seurat_clusters<span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;NK&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>data_150825_nk<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>FeaturePlot<span class="hljs-punctuation">(</span>data_150825<span class="hljs-punctuation">,</span>features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;TIGIT&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;LAG3&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;NKG7&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HAVCR2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ZNF683&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>
<img src="/img/Fig3.I.png" srcset="/img/loading.gif" lazyload style="zoom: 25%;" />
<p>Fig.3.I  GSE150825数据集中的NK细胞被缩小并聚类为五个细胞亚群，NK1-5。</p>
<img src="/img/Fig3.J.png" srcset="/img/loading.gif" lazyload alt="Fig3.J" style="zoom: 33%;" />
<p>Fig.3.J  NKG7、ZNF683、TIGIT、HAVCR2、LAG3和CTLA4在NK1-5亚群中的表达，其中NK-NPC的NK3亚群中ZNF683、TIGIT和LAG3的表达相对较高。</p>
<img src="/img/Fig3.K.png" srcset="/img/loading.gif" lazyload alt="Fig3.K" style="zoom:25%;" />
<p>Fig.3.K  数据集没有找到对应的分组信息，找不到NLH组和NPC组。</p>
<h3 id="4-8-对NK-NPC-单细胞谱进行全局细胞间通讯测定">4.8  对NK-NPC 单细胞谱进行全局细胞间通讯测定</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs R">rm<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span> <span class="hljs-operator">=</span> ls<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>data_162025 <span class="hljs-operator">&lt;-</span> readRDS<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;data_162025_type.RDS&quot;</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># all cellchat</span><br>data.input <span class="hljs-operator">&lt;-</span> data_162025<span class="hljs-operator">@</span>assays<span class="hljs-operator">$</span>RNA<span class="hljs-operator">@</span>data<br>meta.data <span class="hljs-operator">&lt;-</span> data_162025<span class="hljs-operator">@</span>meta.data<br>cellchat <span class="hljs-operator">&lt;-</span> createCellChat<span class="hljs-punctuation">(</span>object<span class="hljs-operator">=</span>data.input<span class="hljs-punctuation">,</span><br>                           meta <span class="hljs-operator">=</span> meta.data<span class="hljs-punctuation">,</span><br>                           group.by<span class="hljs-operator">=</span><span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> addMeta<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>meta <span class="hljs-operator">=</span> meta.data<span class="hljs-punctuation">)</span><br>cellchatDB <span class="hljs-operator">&lt;-</span> CellChatDB.human<br>cellchat<span class="hljs-operator">@</span>DB <span class="hljs-operator">&lt;-</span> cellchatDB<br>cellchat <span class="hljs-operator">&lt;-</span> subsetData<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> identifyOverExpressedGenes<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>do.fast <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> identifyOverExpressedInteractions<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> computeCommunProb<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>population.size <span class="hljs-operator">=</span> <span class="hljs-built_in">F</span><span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> filterCommunication<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>min.cells <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br>df.net <span class="hljs-operator">&lt;-</span> subsetCommunication<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">)</span><br>df.pathway <span class="hljs-operator">&lt;-</span> subsetCommunication<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span>slot.name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;netP&#x27;</span><span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> computeCommunProbPathway<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">)</span><br>cellchat <span class="hljs-operator">&lt;-</span> aggregateNet<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">)</span><br>netVisual_bubble<span class="hljs-punctuation">(</span>cellchat<span class="hljs-punctuation">,</span> sources.use <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><span class="hljs-number">6</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                 targets.use <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span><span class="hljs-number">6</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>signaling <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;GALECTIN&#x27;</span><span class="hljs-punctuation">,</span>remove.isolate <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># Epithelial subtype</span><br>Epi_sub <span class="hljs-operator">&lt;-</span> subset<span class="hljs-punctuation">(</span>data_162025<span class="hljs-punctuation">,</span>subset<span class="hljs-operator">=</span>type<span class="hljs-operator">==</span><span class="hljs-string">&#x27;Epithelial cells&#x27;</span><span class="hljs-punctuation">)</span><br>Epi_sub <span class="hljs-operator">&lt;-</span> NormalizeData<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">)</span><br>Epi_sub <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">)</span><br>Epi_sub <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">)</span><br>Epi_sub <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">)</span><br>ElbowPlot<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>ndims <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">)</span><br>Epi_sub <span class="hljs-operator">&lt;-</span> RunTSNE<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;pca&#x27;</span><span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">)</span><br>Epi_sub <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br>Epi_sub <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.3</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;seurat_clusters&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>Epi_sub<span class="hljs-operator">$</span>type <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-operator">$</span>seurat_clusters<span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Epi&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br>DimPlot<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>label.box <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dim</span><span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># copycat</span><br><span class="hljs-comment"># 鉴定正常细胞和肿瘤细胞</span><br>Epi_cnv <span class="hljs-operator">&lt;-</span> copykat<span class="hljs-punctuation">(</span>rawmat<span class="hljs-operator">=</span>Epi_sub<span class="hljs-operator">@</span>assays<span class="hljs-operator">$</span>RNA<span class="hljs-operator">@</span>counts<span class="hljs-punctuation">,</span> id.type<span class="hljs-operator">=</span><span class="hljs-string">&quot;S&quot;</span><span class="hljs-punctuation">,</span> ngene.chr<span class="hljs-operator">=</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span> win.size<span class="hljs-operator">=</span><span class="hljs-number">25</span><span class="hljs-punctuation">,</span> <br>                   KS.cut<span class="hljs-operator">=</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> sam.name<span class="hljs-operator">=</span><span class="hljs-string">&quot;Epi_sub&quot;</span><span class="hljs-punctuation">,</span> distance<span class="hljs-operator">=</span><span class="hljs-string">&quot;euclidean&quot;</span><span class="hljs-punctuation">,</span> norm.cell.names<span class="hljs-operator">=</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>                   output.seg<span class="hljs-operator">=</span><span class="hljs-string">&quot;FLASE&quot;</span><span class="hljs-punctuation">,</span> plot.genes<span class="hljs-operator">=</span><span class="hljs-string">&quot;TRUE&quot;</span><span class="hljs-punctuation">,</span> genome<span class="hljs-operator">=</span><span class="hljs-string">&quot;hg20&quot;</span><span class="hljs-punctuation">,</span>n.cores<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><br><br>saveRDS<span class="hljs-punctuation">(</span>Epi_cnv<span class="hljs-punctuation">,</span>file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Epi_cnv.RDS&#x27;</span><span class="hljs-punctuation">)</span><br>Epi_cnv <span class="hljs-operator">&lt;-</span> readRDS<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Epi_cnv.RDS&#x27;</span><span class="hljs-punctuation">)</span><br><br>pred.test <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span>Epi_cnv<span class="hljs-operator">$</span>prediction<span class="hljs-punctuation">)</span><br>pred.test <span class="hljs-operator">&lt;-</span> pred.test<span class="hljs-punctuation">[</span><span class="hljs-operator">-</span>which<span class="hljs-punctuation">(</span>pred.test<span class="hljs-operator">$</span>copykat.pred<span class="hljs-operator">==</span><span class="hljs-string">&quot;not.defined&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span>  <span class="hljs-comment">##remove undefined cells</span><br>CNA.test <span class="hljs-operator">&lt;-</span> data.frame<span class="hljs-punctuation">(</span>Epi_cnv<span class="hljs-operator">$</span>CNAmat<span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>pred.test<span class="hljs-punctuation">)</span><br>head<span class="hljs-punctuation">(</span>CNA.test<span class="hljs-punctuation">[</span> <span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">5</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>Epi_sub<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>copykat.pred <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>rownames<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span> <span class="hljs-operator">%in%</span> rownames<span class="hljs-punctuation">(</span>pred.test<span class="hljs-punctuation">[</span>pred.test<span class="hljs-operator">$</span>copykat.pred<span class="hljs-operator">==</span><span class="hljs-string">&#x27;aneuploid&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;aneuploid&#x27;</span><span class="hljs-punctuation">,</span><br>                                         ifelse<span class="hljs-punctuation">(</span>rownames<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-operator">@</span>meta.data<span class="hljs-punctuation">)</span> <span class="hljs-operator">%in%</span> rownames<span class="hljs-punctuation">(</span>pred.test<span class="hljs-punctuation">[</span>pred.test<span class="hljs-operator">$</span>copykat.pred<span class="hljs-operator">==</span><span class="hljs-string">&#x27;diploid&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;diploid&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-literal">NA</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br><br>my_palette <span class="hljs-operator">&lt;-</span> colorRampPalette<span class="hljs-punctuation">(</span>rev<span class="hljs-punctuation">(</span>RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;RdBu&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">999</span><span class="hljs-punctuation">)</span><br><br>chr <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span>CNA.test<span class="hljs-operator">$</span>chrom<span class="hljs-punctuation">)</span> <span class="hljs-operator">%%</span> <span class="hljs-number">2</span><span class="hljs-operator">+</span><span class="hljs-number">1</span><br>rbPal1 <span class="hljs-operator">&lt;-</span> colorRampPalette<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;black&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;grey&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>CHR <span class="hljs-operator">&lt;-</span> rbPal1<span class="hljs-punctuation">(</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span>chr<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>chr1 <span class="hljs-operator">&lt;-</span> cbind<span class="hljs-punctuation">(</span>CHR<span class="hljs-punctuation">,</span>CHR<span class="hljs-punctuation">)</span><br><br>rbPal5 <span class="hljs-operator">&lt;-</span> colorRampPalette<span class="hljs-punctuation">(</span>RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Dark2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>com.preN <span class="hljs-operator">&lt;-</span> pred.test<span class="hljs-operator">$</span>copykat.pred<br>pred <span class="hljs-operator">&lt;-</span> rbPal5<span class="hljs-punctuation">(</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span>factor<span class="hljs-punctuation">(</span>com.preN<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br><br>cells <span class="hljs-operator">&lt;-</span> rbind<span class="hljs-punctuation">(</span>pred<span class="hljs-punctuation">,</span>pred<span class="hljs-punctuation">)</span><br>col_breaks <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span>seq<span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-operator">-</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">50</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>seq<span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span><span class="hljs-operator">-</span><span class="hljs-number">0.2</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">150</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>               seq<span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.2</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.2</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">600</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.2</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">150</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>seq<span class="hljs-punctuation">(</span><span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">length</span><span class="hljs-operator">=</span><span class="hljs-number">50</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>pdf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Fig4_C.pdf&quot;</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br>heatmap.3<span class="hljs-punctuation">(</span>t<span class="hljs-punctuation">(</span>CNA.test<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-number">4</span><span class="hljs-operator">:</span>ncol<span class="hljs-punctuation">(</span>CNA.test<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>dendrogram<span class="hljs-operator">=</span><span class="hljs-string">&quot;r&quot;</span><span class="hljs-punctuation">,</span> <br>          distfun <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> parallelDist<span class="hljs-operator">::</span>parDist<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span>threads <span class="hljs-operator">=</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span> method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;euclidean&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <br>          hclustfun <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> hclust<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span> method<span class="hljs-operator">=</span><span class="hljs-string">&quot;ward.D2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          ColSideColors<span class="hljs-operator">=</span>chr1<span class="hljs-punctuation">,</span>RowSideColors<span class="hljs-operator">=</span>cells<span class="hljs-punctuation">,</span>Colv<span class="hljs-operator">=</span><span class="hljs-literal">NA</span><span class="hljs-punctuation">,</span> Rowv<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><br>          notecol<span class="hljs-operator">=</span><span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span>col<span class="hljs-operator">=</span>my_palette<span class="hljs-punctuation">,</span>breaks<span class="hljs-operator">=</span>col_breaks<span class="hljs-punctuation">,</span> key<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><br>          keysize<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> density.info<span class="hljs-operator">=</span><span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">,</span> trace<span class="hljs-operator">=</span><span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">,</span><br>          cexRow<span class="hljs-operator">=</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span>cexCol<span class="hljs-operator">=</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span>cex.main<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>cex.lab<span class="hljs-operator">=</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span><br>          symm<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span>symkey<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span>symbreaks<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>cex<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> cex.main<span class="hljs-operator">=</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span> margins<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">10</span><span class="hljs-punctuation">,</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>legend<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;topright&quot;</span><span class="hljs-punctuation">,</span> paste<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;pred.&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>table<span class="hljs-punctuation">(</span>com.preN<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>sep<span class="hljs-operator">=</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> pch<span class="hljs-operator">=</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span>col<span class="hljs-operator">=</span>RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Dark2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> cex<span class="hljs-operator">=</span><span class="hljs-number">0.6</span><span class="hljs-punctuation">,</span> bty<span class="hljs-operator">=</span><span class="hljs-string">&quot;n&quot;</span><span class="hljs-punctuation">)</span><br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># 鉴定肿瘤细胞亚型</span><br>tumor.cells <span class="hljs-operator">&lt;-</span> pred.test<span class="hljs-operator">$</span>cell.names<span class="hljs-punctuation">[</span>which<span class="hljs-punctuation">(</span>pred.test<span class="hljs-operator">$</span>copykat.pred<span class="hljs-operator">==</span><span class="hljs-string">&quot;aneuploid&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>tumor.mat <span class="hljs-operator">&lt;-</span> CNA.test<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> which<span class="hljs-punctuation">(</span>colnames<span class="hljs-punctuation">(</span>CNA.test<span class="hljs-punctuation">)</span> <span class="hljs-operator">%in%</span> tumor.cells<span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>hcc <span class="hljs-operator">&lt;-</span> hclust<span class="hljs-punctuation">(</span>parallelDist<span class="hljs-operator">::</span>parDist<span class="hljs-punctuation">(</span>t<span class="hljs-punctuation">(</span>tumor.mat<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>threads <span class="hljs-operator">=</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span> method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;euclidean&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ward.D2&quot;</span><span class="hljs-punctuation">)</span><br>hc.umap <span class="hljs-operator">&lt;-</span> cutree<span class="hljs-punctuation">(</span>hcc<span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><br><br>rbPal6 <span class="hljs-operator">&lt;-</span> colorRampPalette<span class="hljs-punctuation">(</span>RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Dark2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">3</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>subpop <span class="hljs-operator">&lt;-</span> rbPal6<span class="hljs-punctuation">(</span><span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span>factor<span class="hljs-punctuation">(</span>hc.umap<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>cells <span class="hljs-operator">&lt;-</span> rbind<span class="hljs-punctuation">(</span>subpop<span class="hljs-punctuation">,</span>subpop<span class="hljs-punctuation">)</span><br>pdf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Fig4_D.pdf&quot;</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br>heatmap.3<span class="hljs-punctuation">(</span>t<span class="hljs-punctuation">(</span>tumor.mat<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>dendrogram<span class="hljs-operator">=</span><span class="hljs-string">&quot;r&quot;</span><span class="hljs-punctuation">,</span> distfun <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> parallelDist<span class="hljs-operator">::</span>parDist<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span>threads <span class="hljs-operator">=</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span> method <span class="hljs-operator">=</span> <span class="hljs-string">&quot;euclidean&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> hclustfun <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> hclust<span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">,</span> method<span class="hljs-operator">=</span><span class="hljs-string">&quot;ward.D2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>          ColSideColors<span class="hljs-operator">=</span>chr1<span class="hljs-punctuation">,</span>RowSideColors<span class="hljs-operator">=</span>cells<span class="hljs-punctuation">,</span>Colv<span class="hljs-operator">=</span><span class="hljs-literal">NA</span><span class="hljs-punctuation">,</span> Rowv<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><br>          notecol<span class="hljs-operator">=</span><span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span>col<span class="hljs-operator">=</span>my_palette<span class="hljs-punctuation">,</span>breaks<span class="hljs-operator">=</span>col_breaks<span class="hljs-punctuation">,</span> key<span class="hljs-operator">=</span><span class="hljs-literal">TRUE</span><span class="hljs-punctuation">,</span><br>          keysize<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> density.info<span class="hljs-operator">=</span><span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">,</span> trace<span class="hljs-operator">=</span><span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">,</span><br>          cexRow<span class="hljs-operator">=</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span>cexCol<span class="hljs-operator">=</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span>cex.main<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>cex.lab<span class="hljs-operator">=</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span><br>          symm<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span>symkey<span class="hljs-operator">=</span><span class="hljs-built_in">F</span><span class="hljs-punctuation">,</span>symbreaks<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span>cex<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> cex.main<span class="hljs-operator">=</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span> margins<span class="hljs-operator">=</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">10</span><span class="hljs-punctuation">,</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>legend<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;topright&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&quot;c1&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;c2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> pch<span class="hljs-operator">=</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span>col<span class="hljs-operator">=</span>RColorBrewer<span class="hljs-operator">::</span>brewer.pal<span class="hljs-punctuation">(</span>n <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Dark2&quot;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">3</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> cex<span class="hljs-operator">=</span><span class="hljs-number">0.9</span><span class="hljs-punctuation">,</span> bty<span class="hljs-operator">=</span><span class="hljs-string">&#x27;n&#x27;</span><span class="hljs-punctuation">)</span><br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br>Epi_sub<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>copykat.Tumor_pred <span class="hljs-operator">&lt;-</span> ifelse<span class="hljs-punctuation">(</span>colnames<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">)</span> <span class="hljs-operator">%in%</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>hc.umap<span class="hljs-punctuation">[</span>hc.umap<span class="hljs-operator">==</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;tumor cluster1&#x27;</span><span class="hljs-punctuation">,</span><br>                                               ifelse<span class="hljs-punctuation">(</span>colnames<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">)</span> <span class="hljs-operator">%in%</span> <span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>hc.umap<span class="hljs-punctuation">[</span>hc.umap<span class="hljs-operator">==</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;tumor cluster2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;normal&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>p1 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;type&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>p2 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;copykat.pred&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>p3 <span class="hljs-operator">&lt;-</span> DimPlot<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;copykat.Tumor_pred&#x27;</span><span class="hljs-punctuation">,</span>label<span class="hljs-operator">=</span><span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>pdf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Fig4_E.pdf&quot;</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-number">21</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-number">7</span><span class="hljs-punctuation">)</span><br>p1<span class="hljs-operator">+</span>p2<span class="hljs-operator">+</span>p3<br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>pdf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Fig4_F.pdf&quot;</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-number">9</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-number">6</span><span class="hljs-punctuation">)</span><br>DotPlot<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;LGALS9&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HLA-A&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HLA-B&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HLA-C&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HLA-E&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HLA-F&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;HLA-G&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;B2M&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;copykat.Tumor_pred&#x27;</span><span class="hljs-punctuation">)</span><br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>pdf<span class="hljs-punctuation">(</span><span class="hljs-string">&quot;Fig4_G.pdf&quot;</span><span class="hljs-punctuation">,</span>width<span class="hljs-operator">=</span><span class="hljs-number">10</span><span class="hljs-punctuation">,</span>height<span class="hljs-operator">=</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><br><span class="hljs-comment"># EBV感染相关蛋白在两类细胞中的表达</span><br>FeaturePlot<span class="hljs-punctuation">(</span>Epi_sub<span class="hljs-punctuation">,</span>features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;KRT5&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;SSTR2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;LMP-1/BNLF2a/b&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;RPMS1/A73&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>dev.off<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>
<img src="/img/Fig4.A.png" srcset="/img/loading.gif" lazyload style="zoom:33%;" />
<p>Fig.4.A  所有细胞类型之间关于半乳糖凝集素信号传导的细胞间相互作用。</p>
<img src="/img/Fig4.B.png" srcset="/img/loading.gif" lazyload style="zoom:33%;" />
<p>Fig.4.B  Epi1-7 细胞亚群是通过上皮细胞的降维和聚类获得的。</p>
<img src="/img/Fig4.c.png" srcset="/img/loading.gif" lazyload style="zoom: 20%;" />
<p>Fig.4.C   copykat软件识别良恶性上皮细胞，橙色代表拷贝数增加，蓝色代表拷贝数缺失，上面穿插的灰色和黑色代表不同的染色体;Pred.Aneuploid：恶性;pred.diploid：良性。</p>
<img src="/img/Fig4_D.png" srcset="/img/loading.gif" lazyload alt="Fig4_D" style="zoom:15%;" />
<p>Fig.4.D  copykat 软件进一步将恶性肿瘤细胞识别为两种亚型，即肿瘤亚型 1 和肿瘤亚型 2。</p>
<img src="/img/Fig4_E.png" srcset="/img/loading.gif" lazyload style="zoom:20%;" />
<p>Fig.4.E  肿瘤亚型 1 和肿瘤亚型 2 两种亚型在 TNSE 图中绘制。</p>
<img src="/img/Fig4_F.png" srcset="/img/loading.gif" lazyload style="zoom:20%;" />
<p>Fig.4.F  LGALS9 和 MHC I 类分子在肿瘤亚型 1 和肿瘤亚型 2 中的表达。</p>
<img src="/img/Fig4_G.png" srcset="/img/loading.gif" lazyload alt="Fig4_G" style="zoom:20%;" />
<p>Fig.4.G   KRT5、SSTR2、LMP-1/BNLF2a/b和RPMS1/A73在肿瘤亚型1和肿瘤亚型2中的表达和分布。</p>
<h3 id="4-9-NK-NPCtumor1-亚群细胞进化轨迹和功能富集分析">4.9  NK-NPCtumor1 亚群细胞进化轨迹和功能富集分析</h3>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># tumor1 亚群</span><br>tumor1_sub <span class="hljs-operator">&lt;-</span> Epi_sub<span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span> Epi_sub<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>copykat.Tumor_pred <span class="hljs-operator">==</span> <span class="hljs-string">&#x27;tumor cluster1&#x27;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">]</span><br><br>tumor1_sub <span class="hljs-operator">&lt;-</span> NormalizeData<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">)</span><br>tumor1_sub <span class="hljs-operator">&lt;-</span> FindVariableFeatures<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">)</span><br>tumor1_sub <span class="hljs-operator">&lt;-</span> ScaleData<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">)</span><br>tumor1_sub <span class="hljs-operator">&lt;-</span> RunPCA<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">)</span><br>ElbowPlot<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">,</span>ndims <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">)</span><br>tumor1_sub <span class="hljs-operator">&lt;-</span> RunTSNE<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;pca&#x27;</span><span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">)</span><br>tumor1_sub <span class="hljs-operator">&lt;-</span> FindNeighbors<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">,</span>dims <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br>tumor1_sub <span class="hljs-operator">&lt;-</span> FindClusters<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">,</span>resolution <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><br>DimPlot<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">,</span>reduction <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;tsne&#x27;</span><span class="hljs-punctuation">,</span>group.by <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;seurat_clusters&#x27;</span><span class="hljs-punctuation">,</span>label <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br>tumor1_sub<span class="hljs-operator">$</span>type <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-operator">$</span>seurat_clusters<span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Epi&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># SCORPIUS 拟时序</span><br>group_name <span class="hljs-operator">&lt;-</span> <span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span>as.factor<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>type<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>group_name<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> tumor1_sub<span class="hljs-operator">@</span>meta.data<span class="hljs-operator">$</span>type<br>group_name <span class="hljs-operator">&lt;-</span> as.factor<span class="hljs-punctuation">(</span>group_name<span class="hljs-punctuation">)</span><br><br>space <span class="hljs-operator">&lt;-</span> reduce_dimensionality<span class="hljs-punctuation">(</span>t<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-operator">@</span>assays<span class="hljs-operator">$</span>RNA<span class="hljs-operator">@</span>data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;spearman&quot;</span><span class="hljs-punctuation">)</span><br>draw_trajectory_plot<span class="hljs-punctuation">(</span>space<span class="hljs-punctuation">,</span>group_name<span class="hljs-punctuation">,</span> contour <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br><br>traj <span class="hljs-operator">&lt;-</span> infer_trajectory<span class="hljs-punctuation">(</span>space<span class="hljs-punctuation">)</span><br>draw_trajectory_plot<span class="hljs-punctuation">(</span>space<span class="hljs-punctuation">,</span> group_name<span class="hljs-punctuation">,</span> traj<span class="hljs-operator">$</span>path<span class="hljs-punctuation">,</span> contour <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br><br>gimp <span class="hljs-operator">&lt;-</span> gene_importances<span class="hljs-punctuation">(</span><br>  t<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-operator">@</span>assays<span class="hljs-operator">$</span>RNA<span class="hljs-operator">@</span>scale.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <br>  traj<span class="hljs-operator">$</span>time<span class="hljs-punctuation">,</span> <br>  num_permutations <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span> <br>  num_threads <span class="hljs-operator">=</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> <br>  ntree <span class="hljs-operator">=</span> <span class="hljs-number">10000</span><span class="hljs-punctuation">,</span><br>  ntree_perm <span class="hljs-operator">=</span> <span class="hljs-number">1000</span><br><span class="hljs-punctuation">)</span><br>gimp<span class="hljs-operator">$</span>qvalue <span class="hljs-operator">&lt;-</span> p.adjust<span class="hljs-punctuation">(</span>gimp<span class="hljs-operator">$</span>pvalue<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;BH&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>gimp<span class="hljs-operator">$</span>pvalue<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>gene_sel <span class="hljs-operator">&lt;-</span> gimp<span class="hljs-operator">$</span>gene<span class="hljs-punctuation">[</span>gimp<span class="hljs-operator">$</span>qvalue <span class="hljs-operator">&lt;</span> <span class="hljs-number">.05</span><span class="hljs-punctuation">]</span><br>expr_sel <span class="hljs-operator">&lt;-</span> scale_quantile<span class="hljs-punctuation">(</span>t<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-operator">@</span>assays<span class="hljs-operator">$</span>RNA<span class="hljs-operator">@</span>scale.data<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span>gene_sel<span class="hljs-punctuation">]</span><span class="hljs-punctuation">)</span><br>time <span class="hljs-operator">&lt;-</span> traj<span class="hljs-operator">$</span>time<br>draw_trajectory_heatmap<span class="hljs-punctuation">(</span>expr_sel<span class="hljs-punctuation">,</span> time<span class="hljs-punctuation">,</span>progression_group<span class="hljs-operator">=</span>group_name<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># tumor1 差异</span><br>tumor1_sub_markers <span class="hljs-operator">&lt;-</span> FindAllMarkers<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">)</span><br>tumor1_sub_markers<span class="hljs-operator">$</span>cluster <span class="hljs-operator">&lt;-</span> sapply<span class="hljs-punctuation">(</span>tumor1_sub_markers<span class="hljs-operator">$</span>cluster<span class="hljs-punctuation">,</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#123;</span>paste0<span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;Epi&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-built_in">as.numeric</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">)</span><br>jjVolcano<span class="hljs-punctuation">(</span>tumor1_sub_markers<span class="hljs-punctuation">)</span><br>VlnPlot<span class="hljs-punctuation">(</span>tumor1_sub<span class="hljs-punctuation">,</span>features <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">&#x27;KRT5&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;VIM&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;SSTR2&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;LMP-1/BNLF2a/b&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;RPS18&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;RPS23&#x27;</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>tumor1_sub_deg <span class="hljs-operator">&lt;-</span> tumor1_sub_markers<span class="hljs-punctuation">[</span>tumor1_sub_markers<span class="hljs-operator">$</span>cluster<span class="hljs-operator">==</span><span class="hljs-string">&#x27;Epi1&#x27;</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">]</span><br>tumor1_sub_marker <span class="hljs-operator">&lt;-</span> tumor1_sub_deg<span class="hljs-operator">$</span>avg_log2FC<br><span class="hljs-built_in">names</span><span class="hljs-punctuation">(</span>tumor1_sub_marker<span class="hljs-punctuation">)</span> <span class="hljs-operator">&lt;-</span> bitr<span class="hljs-punctuation">(</span>tumor1_sub_deg<span class="hljs-operator">$</span>gene<span class="hljs-punctuation">,</span>fromType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;SYMBOL&#x27;</span><span class="hljs-punctuation">,</span>toType <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">,</span>OrgDb <span class="hljs-operator">=</span> org.Hs.eg.db<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">,</span><span class="hljs-string">&#x27;ENTREZID&#x27;</span><span class="hljs-punctuation">]</span><br>tumor1_sub_marker <span class="hljs-operator">&lt;-</span> sort<span class="hljs-punctuation">(</span>tumor1_sub_marker<span class="hljs-punctuation">,</span>decreasing <span class="hljs-operator">=</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">)</span><br><br>tumor1 <span class="hljs-operator">&lt;-</span> gseKEGG<span class="hljs-punctuation">(</span>tumor1_sub_marker<span class="hljs-punctuation">)</span><br>gseaplot2<span class="hljs-punctuation">(</span>tumor1<span class="hljs-punctuation">,</span>geneSetID <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure>
<img src="/img/Fig5.A.png" srcset="/img/loading.gif" lazyload style="zoom:33%;" />
<p>Fig.5.A   Epi T1-4 细胞亚群是通过肿瘤亚型 1 亚群的降维和聚类获得的。</p>
<img src="/img/Fig5.B3.png" srcset="/img/loading.gif" lazyload alt="Fig5.B3" style="zoom:33%;" />
<p>Fig.5.B  考虑到EBV活性状态对tumor1可能有影响，于是把tumor1单拎出来进行拟时序分析，这里就随便选一个亚群了。</p>
<img src="/img/Fig5.B.png" srcset="/img/loading.gif" lazyload alt="Fig5.B" style="zoom:33%;" />
<img src="/img/Fig5.B2.png" srcset="/img/loading.gif" lazyload alt="Fig5.B2" style="zoom: 33%;" />
<p>Fig.5.B  拟时序分析，肿瘤亚型1的细胞进化轨迹：从0到1的时间，上皮细胞进化轨迹方向从Epi T1-Epi T4，对应全局基因表达变化。红色表示高表达，蓝色表示低表达。</p>
<img src="/img/Fig5.C.png" srcset="/img/loading.gif" lazyload alt="Fig5.C" style="zoom:25%;" />
<p>Fig.5.C  Epi T1-4 亚群的标记基因</p>
<img src="/img/Fig5.D.png" srcset="/img/loading.gif" lazyload alt="Fig5.D" style="zoom:25%;" />
<p>Fig.5.D  Violin 图显示了 Epi T1-T4 亚群中 KRT5、VIM、SSTR2、LMP-1/BNLF2a/b、RPS18 和 RPS23 基因的表达及其变异变化。</p>
<img src="/img/Fig5.E.png" srcset="/img/loading.gif" lazyload alt="Fig5.E" style="zoom: 33%;" />
<p>Fig.5.E  亚群各标记基因的 GSEA 富集分析。</p>
<h2 id="5-结论">5  结论</h2>
<p>综上所述，本研究揭示了NK-NPC的NK细胞耗竭情况。肿瘤细胞可能通过产生与NK细胞表面的抑制性受体结合的负配体来诱导NK细胞的功能抑制和耗竭。此外，肿瘤细胞可能通过NK-NPC中LGALS9的表达来抑制NK细胞的功能。本研究首次进一步确定了NK-NPC中EBV活性状态下肿瘤细胞的独特进化轨迹。我们的研究结果为不同阶段的肿瘤监测提供了潜在的治疗靶点和可能的生物标志物，从而提高了NK-NPC患者的生存率。然而，还需要进一步的功能实验来研究潜在的机制。</p>
<h2 id="6-复现心得">6  复现心得</h2>
<ol>
<li>
<p>RDS vs. RData vs. RDA:</p>
<table>
<thead>
<tr>
<th>格式</th>
<th>用途</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>RData</td>
<td>保存整个 R 环境</td>
<td>快速加载和保存整个 R 环境</td>
<td>文件大小大</td>
</tr>
<tr>
<td>RDA</td>
<td>保存单个 R 对象</td>
<td>储存大型对象有效</td>
<td>只保存单个对象</td>
</tr>
<tr>
<td>RDS</td>
<td>保存二进制序列化的 R 对象</td>
<td>文件大小小，加载速度快，跨平台兼容</td>
<td>只适用于 R 对象</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>当某一流程为限速步骤时，最好能将结果对象保存为文件，以便需要时可再次读入。</p>
</li>
<li>
<p>Seurat对象中储存了关于这个单细胞项目的几乎所有信息，包括每个细胞的barcodes，原始表达矩阵以及运行过哪些分析等，后续对单细胞的分群注释等信息都是保存在Seurat对象中的。在R中可以使用str()函数查看数据结构。</p>
<img src="/img/单细胞seurat对象数据结构.png" srcset="/img/loading.gif" lazyload style="zoom:33%;" />
</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/scRNA-seq/" class="category-chain-item">scRNA-seq</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/R/" class="print-no-link">#R</a>
      
        <a href="/tags/scRNA-seq/" class="print-no-link">#scRNA-seq</a>
      
        <a href="/tags/paper-reproducing/" class="print-no-link">#paper-reproducing</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>一篇基于R语言的scRNA-seq文章复现</div>
      <div>http://horizongazer.github.io/2024/05/20/一篇基于R语言的scRNA-seq文章复现/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>HorizonGazer</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年5月20日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                    <i class="iconfont icon-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/06/30/single_cell_tutorial/" title="scRNA-seq最佳实践教程">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">scRNA-seq最佳实践教程</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/03/10/DUT%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E4%B8%8E%E4%B8%93%E5%AE%B6%E7%B3%BB%E7%BB%9F_HW4/" title="DUT人工智能与专家系统_HW4">
                        <span class="hidden-mobile">DUT人工智能与专家系统_HW4</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"kSreM0uY5jXWPRahJhw2LDbE-gzGzoHsz","appKey":"Ux8qZ1XPuB6R9or0uKIElE9b","path":"window.location.pathname","placeholder":"留言仅限讨论，禁止广告等行为","avatar":"robohash","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://ksrem0uy.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appid":"kSreM0uY5jXWPRahJhw2LDbE-gzGzoHsz","appkey":"Ux8qZ1XPuB6R9or0uKIElE9b"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/custom.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
